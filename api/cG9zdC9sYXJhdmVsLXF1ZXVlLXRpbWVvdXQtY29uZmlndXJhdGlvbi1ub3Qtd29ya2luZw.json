{"title":"laravel-queue-timeout-configuration-not-working","date":"2019-07-04T00:00:00.000Z","link":"post/laravel-queue-timeout-configuration-not-working","tags":["laravel-queue"],"categories":["program"],"updated":"2019-07-04T00:00:00.000Z","content":"<p>laravel 设置队列超时时间，但是并没有生效</p>\n<h2 id=\"Development-environments\">Development environments<a href=\"post/laravel-queue-timeout-configuration-not-working#Development-environments\"></a></h2><p>laravel : v5.5   </p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># https://laravel.com/docs/5.5/installation</span></span><br><span class=\"line\">laravel5.5 server requirements : PHP &gt;= 7.0.0</span><br></pre></td></tr></table></div></figure>\n<p>php : v7.1.30</p>\n<h2 id=\"code\">code<a href=\"post/laravel-queue-timeout-configuration-not-working#code\"></a></h2><h3 id=\"Controller\">Controller<a href=\"post/laravel-queue-timeout-configuration-not-working#Controller\"></a></h3><figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">App</span>\\<span class=\"title\">Http</span>\\<span class=\"title\">Controllers</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">App</span>\\<span class=\"title\">Jobs</span>\\<span class=\"title\">Test</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">QueueController</span> <span class=\"keyword\">extends</span> <span class=\"title\">Controller</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">index</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'queue start'</span>;</span><br><span class=\"line\">        Test::dispatch()-&gt;onQueue(<span class=\"string\">'testQueue'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'queue end'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Job\">Job<a href=\"post/laravel-queue-timeout-configuration-not-working#Job\"></a></h3><figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">App</span>\\<span class=\"title\">Jobs</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">App</span>\\<span class=\"title\">User</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Bus</span>\\<span class=\"title\">Queueable</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Queue</span>\\<span class=\"title\">SerializesModels</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Queue</span>\\<span class=\"title\">InteractsWithQueue</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Contracts</span>\\<span class=\"title\">Queue</span>\\<span class=\"title\">ShouldQueue</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Foundation</span>\\<span class=\"title\">Bus</span>\\<span class=\"title\">Dispatchable</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Support</span>\\<span class=\"title\">Facades</span>\\<span class=\"title\">Log</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> <span class=\"keyword\">implements</span> <span class=\"title\">ShouldQueue</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">use</span> <span class=\"title\">Dispatchable</span>, <span class=\"title\">InteractsWithQueue</span>, <span class=\"title\">Queueable</span>, <span class=\"title\">SerializesModels</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $tries = <span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $timeout = <span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        Log::error(<span class=\"string\">'queue start'</span>);</span><br><span class=\"line\">        sleep(<span class=\"number\">10</span>);</span><br><span class=\"line\">        Log::error(<span class=\"string\">'queue end'</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>调用控制器，会发现，队列设置的超时时间无效</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[2019-07-04 03:16:38][42] Processing: App\\Jobs\\Test</span><br><span class=\"line\">[2019-07-04 03:16:48][42] Processed:  App\\Jobs\\Test</span><br></pre></td></tr></table></div></figure>\n<p>日志同样会被打印</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local.ERROR: queue start </span><br><span class=\"line\">local.ERROR: queue end</span><br></pre></td></tr></table></div></figure>\n<p>这是为什么呢</p>\n<p> <a href=\"https://github.com/laravel/framework/issues/19584\" target=\"_blank\" rel=\"noopener\">Timeout settings not kill job in queue Laravel 5.4</a></p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Timeouts also require PHP 7.1 to work.</span><br><span class=\"line\"></span><br><span class=\"line\">Ref: Worker::registerTimeoutHandler</span><br><span class=\"line\">Ref: Worker::supportsAsyncSignals</span><br></pre></td></tr></table></div></figure>\n<p>Laravel Queue Worker</p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Illuminate\\Queue\\Worker</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Register the worker timeout handler (PHP 7.1+).</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>  \\Illuminate\\Contracts\\Queue\\Job|null  $job</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>  WorkerOptions  $options</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> void</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerTimeoutHandler</span><span class=\"params\">($job, WorkerOptions $options)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">$this</span>-&gt;supportsAsyncSignals()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// We will register a signal handler for the alarm signal so that we can kill this</span></span><br><span class=\"line\">            <span class=\"comment\">// process if it is running too long because it has frozen. This uses the async</span></span><br><span class=\"line\">            <span class=\"comment\">// signals supported in recent versions of PHP to accomplish it conveniently.</span></span><br><span class=\"line\">            pcntl_signal(SIGALRM, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;kill(<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            $timeout = <span class=\"keyword\">$this</span>-&gt;timeoutForJob($job, $options);</span><br><span class=\"line\">            pcntl_alarm($timeout &gt; <span class=\"number\">0</span> ? $timeout + $options-&gt;sleep : <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Determine if \"async\" signals are supported.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> bool</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">supportsAsyncSignals</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> version_compare(PHP_VERSION, <span class=\"string\">'7.1.0'</span>) &gt;= <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">               extension_loaded(<span class=\"string\">'pcntl'</span>);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></div></figure>\n<p>从上述代码可以看出，<code>registerTimeoutHandler</code> 超时处理需要两个条件</p>\n<ul>\n<li>php 版本 &gt;= 7.1</li>\n<li>已安装 pcntl 扩展</li>\n</ul>\n<p>命令行执行以下命令查看 pcntl 扩展情况</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php -m | grep pcntl</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"Solution\">Solution<a href=\"post/laravel-queue-timeout-configuration-not-working#Solution\"></a></h2><ul>\n<li><p>安装 pcntl 扩展</p>\n</li>\n<li><p>php 版本 &gt;= 7.1</p>\n</li>\n</ul>\n<h2 id=\"References\">References<a href=\"post/laravel-queue-timeout-configuration-not-working#References\"></a></h2><ul>\n<li><p><a href=\"https://github.com/laravel/framework/issues/19584\" target=\"_blank\" rel=\"noopener\">Timeout settings not kill job in queue Laravel 5.4</a></p>\n</li>\n<li><p><a href=\"https://www.php.net/manual/en/intro.pcntl.php\" target=\"_blank\" rel=\"noopener\">pcntl extension</a></p>\n</li>\n</ul>\n","next":{"title":"upgrade-mac-php-version.md","link":"post/upgrade-mac-php-version.md"},"plink":"https://spaco.github.io/post/laravel-queue-timeout-configuration-not-working/","toc":[{"title":"Development environments","id":"Development-environments","index":"1"},{"title":"code","id":"code","index":"2","children":[{"title":"Controller","id":"Controller","index":"2.1"},{"title":"Job","id":"Job","index":"2.2"}]},{"title":"Solution","id":"Solution","index":"3"},{"title":"References","id":"References","index":"4"}],"reward":true,"copyright":{"link":"<a href=\"https://spaco.github.io/post/laravel-queue-timeout-configuration-not-working/\" title=\"laravel-queue-timeout-configuration-not-working\">https://spaco.github.io/post/laravel-queue-timeout-configuration-not-working/</a>","license":"自由转载-非商用-禁止演绎-保持署名 (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)","author":"Spaco"}}