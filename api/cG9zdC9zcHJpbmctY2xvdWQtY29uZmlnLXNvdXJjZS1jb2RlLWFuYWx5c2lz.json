{"title":"spring cloud config source code analysis","date":"2019-09-30T00:00:00.000Z","link":"post/spring-cloud-config-source-code-analysis","tags":["spring-cloud"],"categories":["program"],"updated":"2019-09-30T00:00:00.000Z","content":"<h1 id=\"Spring-Cloud-Config-Source-code-analysis\">Spring Cloud Config Source code analysis<a href=\"post/spring-cloud-config-source-code-analysis#Spring-Cloud-Config-Source-code-analysis\"></a></h1><p>config client 请求 config server接口，config server 拉取 git repository 的代码，然后反馈给 config client</p>\n<h2 id=\"Config-Server\">Config Server<a href=\"post/spring-cloud-config-source-code-analysis#Config-Server\"></a></h2><h3 id=\"入口文件\">入口文件<a href=\"post/spring-cloud-config-source-code-analysis#入口文件\"></a></h3><figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.SpringApplication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SpringBootApplication</span></span><br><span class=\"line\"><span class=\"meta\">@EnableConfigServer</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigServerApplication</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">\t\tSpringApplication.run(ConfigServerApplication.class, args);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p><code>@EnableConfigServer</code> ：使服务成为配置中心</p>\n<h3 id=\"EnableConfigServer\">EnableConfigServer<a href=\"post/spring-cloud-config-source-code-analysis#EnableConfigServer\"></a></h3><figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Documented;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.ElementType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Retention;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Target;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cloud.config.server.config.ConfigServerConfiguration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Import;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Target</span>(ElementType.TYPE)</span><br><span class=\"line\"><span class=\"meta\">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Import</span>(ConfigServerConfiguration.class)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> EnableConfigServer &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>作用：主要是引入 <code>ConfigServerConfiguration.class</code></p>\n<h3 id=\"ConfigServerConfiguration-class\">ConfigServerConfiguration.class<a href=\"post/spring-cloud-config-source-code-analysis#ConfigServerConfiguration-class\"></a></h3><figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigServerConfiguration</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Bean</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> Marker <span class=\"title\">enableConfigServerMarker</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Marker();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Marker</span> </span>&#123;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>config server 配置类</p>\n<p>作用：装配 <code>Marker</code> Bean，开启 <code>ConfigServerAutoConfiguration</code></p>\n<h3 id=\"ConfigServerAutoConfiguration\">ConfigServerAutoConfiguration<a href=\"post/spring-cloud-config-source-code-analysis#ConfigServerAutoConfiguration\"></a></h3><figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnBean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Import;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnBean</span>(ConfigServerConfiguration.Marker.class)</span><br><span class=\"line\"><span class=\"meta\">@EnableConfigurationProperties</span>(ConfigServerProperties.class)</span><br><span class=\"line\"><span class=\"meta\">@Import</span>(&#123; EnvironmentRepositoryConfiguration.class, CompositeConfiguration.class,</span><br><span class=\"line\">\t\tResourceRepositoryConfiguration.class, ConfigServerEncryptionConfiguration.class,</span><br><span class=\"line\">\t\tConfigServerMvcConfiguration.class &#125;)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigServerAutoConfiguration</span> </span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p><code>@ConditionalOnBean(ConfigServerConfiguration.Marker.class)</code> 从这个可以看出，<code>ConfigServerAutoConfiguration</code>的前提条件：<code>ConfigServerConfiguration.Marker.class</code> Bean存在</p>\n<p>引入多个配置类</p>\n<p>作用：</p>\n<ul>\n<li>引入<code>EnvironmentRepositoryConfiguration</code> ： 配置中心的关键 Configuration 类</li>\n<li>引入其他（待续）</li>\n</ul>\n<h3 id=\"EnvironmentRepositoryConfiguration-class\">EnvironmentRepositoryConfiguration.class<a href=\"post/spring-cloud-config-source-code-analysis#EnvironmentRepositoryConfiguration-class\"></a></h3><p>为什么说 <code>EnvironmentRepositoryConfiguration.class</code> 是关键配置类呢？</p>\n<p>这个配置类中包含很多实现了<code>org.springframework.cloud.config.server.environment.EnvironmentRepository</code>接口的类，每个实现类都对应一种类型（git/svn/navtie/vault）的配置。 EnvironmentRepositoryConfiguration通过profile注解（对当前应用的环境）决定使用装配哪个<code>EnvironmentRepository</code> Bean。默认是<code>MultipleJGitEnvironmentRepository</code></p>\n<p><code>EnvironmentRepository</code> 接口实现作用：根据 <code>application</code> <code>profile</code> <code>label</code> 找到对应的配置文件</p>\n<p>作用：</p>\n<ul>\n<li>引入Git Svn Native Vault等配置类</li>\n<li>实现各个实现方式</li>\n</ul>\n<figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableConfigurationProperties</span>(&#123; SvnKitEnvironmentProperties.class,</span><br><span class=\"line\">\t\tCredhubEnvironmentProperties.class, JdbcEnvironmentProperties.class,</span><br><span class=\"line\">\t\tNativeEnvironmentProperties.class, VaultEnvironmentProperties.class &#125;)</span><br><span class=\"line\"><span class=\"meta\">@Import</span>(&#123; CompositeRepositoryConfiguration.class, JdbcRepositoryConfiguration.class,</span><br><span class=\"line\">\t\tVaultConfiguration.class, VaultRepositoryConfiguration.class,</span><br><span class=\"line\">\t\tCredhubConfiguration.class, CredhubRepositoryConfiguration.class,</span><br><span class=\"line\">\t\tSvnRepositoryConfiguration.class, NativeRepositoryConfiguration.class,</span><br><span class=\"line\">\t\tGitRepositoryConfiguration.class, DefaultRepositoryConfiguration.class &#125;)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EnvironmentRepositoryConfiguration</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//忽略部分代码</span></span><br><span class=\"line\">  <span class=\"meta\">@Configuration</span></span><br><span class=\"line\">\t<span class=\"meta\">@ConditionalOnClass</span>(TransportConfigCallback.class)</span><br><span class=\"line\">\t<span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JGitFactoryConfig</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"meta\">@Bean</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> MultipleJGitEnvironmentRepositoryFactory <span class=\"title\">gitEnvironmentRepositoryFactory</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t\tConfigurableEnvironment environment, ConfigServerProperties server,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t\tOptional&lt;ConfigurableHttpConnectionFactory&gt; jgitHttpConnectionFactory,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t\tOptional&lt;TransportConfigCallback&gt; customTransportConfigCallback)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> MultipleJGitEnvironmentRepositoryFactory(environment, server,</span><br><span class=\"line\">\t\t\t\t\tjgitHttpConnectionFactory, customTransportConfigCallback);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  <span class=\"comment\">//忽略部分代码</span></span><br><span class=\"line\">  <span class=\"meta\">@Configuration</span></span><br><span class=\"line\">\t<span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">NativeFactoryConfig</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"meta\">@Bean</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">public</span> NativeEnvironmentRepositoryFactory <span class=\"title\">nativeEnvironmentRepositoryFactory</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t\tConfigurableEnvironment environment, ConfigServerProperties properties)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> NativeEnvironmentRepositoryFactory(environment, properties);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  <span class=\"comment\">//忽略部分代码</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"为什么默认是Git-仓库\">为什么默认是Git 仓库<a href=\"post/spring-cloud-config-source-code-analysis#为什么默认是Git-仓库\"></a></h4><figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnMissingBean</span>(value = EnvironmentRepository.class, search = SearchStrategy.CURRENT)</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultRepositoryConfiguration</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Bean</span></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> MultipleJGitEnvironmentRepository <span class=\"title\">defaultEnvironmentRepository</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tMultipleJGitEnvironmentRepositoryFactory gitEnvironmentRepositoryFactory,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tMultipleJGitEnvironmentProperties environmentProperties)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> gitEnvironmentRepositoryFactory.build(environmentProperties);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>可以看到，<code>@ConditionalOnMissingBean(value = EnvironmentRepository.class, search = SearchStrategy.CURRENT)</code>，此时，返回的是<code>MultipleJGitEnvironmentRepository</code></p>\n<h3 id=\"EnvironmentRepository\">EnvironmentRepository<a href=\"post/spring-cloud-config-source-code-analysis#EnvironmentRepository\"></a></h3><p>是一个配置管理仓库接口，抽象了获取配置的方法:</p>\n<p>作用：根据 <code>application</code> <code>profile</code> <code>label</code> 找到对应的配置文件，所有获取配置的实现方式（git/svn/navtie/vault）都会实现此接口</p>\n<figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server.environment;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cloud.config.environment.Environment;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">EnvironmentRepository</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"function\">Environment <span class=\"title\">findOne</span><span class=\"params\">(String application, String profile, String label)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>它的实现类很多，如下图：</p>\n<p><img src=\"https://spaco.oss-cn-hangzhou.aliyuncs.com/spring-cloud/spring-cloud-config-server-repository.png\" alt=\"\" class=\"article-img\"></p>\n<p>从文件名中大概可以看出，这些类应该是用于加载不同类型的配置（后面会再介绍）。<br>有了获取配置的类，还差对外提供接口的类，就是<code>org.springframework.cloud.config.server.environment.EnvironmentController</code></p>\n<h3 id=\"EnvironmentController\">EnvironmentController<a href=\"post/spring-cloud-config-source-code-analysis#EnvironmentController\"></a></h3><p><code>EnvironmentController</code>是<code>spring-cloud-config-server</code>包的一个控制器类</p>\n<p>作用：提供对外接口，根据接口传递参数获取对应配置</p>\n<figure class=\"highlight java\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.springframework.cloud.config.server.environment;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(method = RequestMethod.GET, path = <span class=\"string\">\"$&#123;spring.cloud.config.server.prefix:&#125;\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EnvironmentController</span> </span>&#123;</span><br><span class=\"line\">  \t<span class=\"keyword\">private</span> EnvironmentRepository repository;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> ObjectMapper objectMapper;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> stripDocument = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> acceptEmpty = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">EnvironmentController</span><span class=\"params\">(EnvironmentRepository repository)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>(repository, <span class=\"keyword\">new</span> ObjectMapper());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">EnvironmentController</span><span class=\"params\">(EnvironmentRepository repository,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tObjectMapper objectMapper)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.repository = repository;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.objectMapper = objectMapper;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 省略部分代码</span></span><br><span class=\"line\">\t<span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/&#123;name&#125;/&#123;profiles&#125;/&#123;label:.*&#125;\"</span>)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> Environment <span class=\"title\">labelled</span><span class=\"params\">(@PathVariable String name, @PathVariable String profiles,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t@PathVariable String label)</span> </span>&#123;</span><br><span class=\"line\">  \t<span class=\"keyword\">if</span> (name != <span class=\"keyword\">null</span> &amp;&amp; name.contains(<span class=\"string\">\"(_)\"</span>)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// \"(_)\" is uncommon in a git repo name, but \"/\" cannot be matched</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// by Spring MVC</span></span><br><span class=\"line\">\t\t\tname = name.replace(<span class=\"string\">\"(_)\"</span>, <span class=\"string\">\"/\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (label != <span class=\"keyword\">null</span> &amp;&amp; label.contains(<span class=\"string\">\"(_)\"</span>)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// \"(_)\" is uncommon in a git branch name, but \"/\" cannot be matched</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// by Spring MVC</span></span><br><span class=\"line\">\t\t\tlabel = label.replace(<span class=\"string\">\"(_)\"</span>, <span class=\"string\">\"/\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tEnvironment environment = <span class=\"keyword\">this</span>.repository.findOne(name, profiles, label);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.acceptEmpty</span><br><span class=\"line\">\t\t\t\t&amp;&amp; (environment == <span class=\"keyword\">null</span> || environment.getPropertySources().isEmpty())) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> EnvironmentNotFoundException(<span class=\"string\">\"Profile Not found\"</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> environment;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/&#123;label&#125;/&#123;name&#125;-&#123;profiles&#125;.properties\"</span>)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">labelledProperties</span><span class=\"params\">(@PathVariable String name,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t@PathVariable String profiles, @PathVariable String label,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t@RequestParam(defaultValue = <span class=\"string\">\"true\"</span>)</span> <span class=\"keyword\">boolean</span> resolvePlaceholders)</span></span><br><span class=\"line\"><span class=\"function\">\t\t\t<span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 省略部分代码</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/&#123;label&#125;/&#123;name&#125;-&#123;profiles&#125;.json\"</span>)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">labelledJsonProperties</span><span class=\"params\">(@PathVariable String name,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t@PathVariable String profiles, @PathVariable String label,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t@RequestParam(defaultValue = <span class=\"string\">\"true\"</span>)</span> <span class=\"keyword\">boolean</span> resolvePlaceholders)</span></span><br><span class=\"line\"><span class=\"function\">\t\t\t<span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">    \t<span class=\"comment\">// 省略部分代码</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>以 <code>labelled</code> 方法为例，本质上，是通过 <code>EnvironmentRepository</code> （即我们上面说的配置仓库类）调用 <code>findOne</code>方法，得到对应的配置</p>\n<h3 id=\"小结\">小结<a href=\"post/spring-cloud-config-source-code-analysis#小结\"></a></h3><p>配置中心通过<code>org.springframework.cloud.config.server.environment.EnvironmentController</code>提供外部访问配置接口，通过实现 <code>org.springframework.cloud.config.server.environment.EnvironmentRepository</code>配置仓库接口类获取配置，默认是 Git</p>\n","next":{"title":"Load balancing","link":"post/load-balancing"},"plink":"https://spaco.github.io/post/spring-cloud-config-source-code-analysis/","toc":[{"title":"Spring Cloud Config Source code analysis","id":"Spring-Cloud-Config-Source-code-analysis","index":"1","children":[{"title":"Config Server","id":"Config-Server","index":"1.1","children":[{"title":"入口文件","id":"入口文件","index":"1.1.1"},{"title":"EnableConfigServer","id":"EnableConfigServer","index":"1.1.2"},{"title":"ConfigServerConfiguration.class","id":"ConfigServerConfiguration-class","index":"1.1.3"},{"title":"ConfigServerAutoConfiguration","id":"ConfigServerAutoConfiguration","index":"1.1.4"},{"title":"EnvironmentRepositoryConfiguration.class","id":"EnvironmentRepositoryConfiguration-class","index":"1.1.5"},{"title":"EnvironmentRepository","id":"EnvironmentRepository","index":"1.1.6"},{"title":"EnvironmentController","id":"EnvironmentController","index":"1.1.7"},{"title":"小结","id":"小结","index":"1.1.8"}]}]}]}