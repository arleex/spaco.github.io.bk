{"title":"","date":"2018-12-17T01:15:50.199Z","slug":"DBmigration-flyway","updated":"2018-12-17T01:15:50.199Z","content":"<h2 id=\"Flyway\"><a href=\"#Flyway\" class=\"headerlink\" title=\"Flyway\"></a>Flyway</h2><h3 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h3><p>Version control for your database.Robust schema evolution across all your environments.With ease, pleasure and plain SQL.</p>\n<p>数据库的版本控制。跨所有环境的强大架构演变。轻松，愉快和简单的SQL</p>\n<p><a href=\"https://flywaydb.org/\" target=\"_blank\" rel=\"noopener\">官网</a></p>\n<p><a href=\"https://flywaydb.org/getstarted/how\" target=\"_blank\" rel=\"noopener\">How Flyway works</a></p>\n<h4 id=\"Development-environment\"><a href=\"#Development-environment\" class=\"headerlink\" title=\"Development environment\"></a>Development environment</h4><ul>\n<li><p>flyway </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version : 5.2.4</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>mysql</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version : 5.7</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h3><p><a href=\"https://hub.docker.com/r/boxfuse/flyway/\" target=\"_blank\" rel=\"noopener\">docker-boxfuse-flyway</a></p>\n<p><code>关注 Supported Volumes</code></p>\n<p><code>见底部 docker-compose.yml</code></p>\n<h3 id=\"Configuration\"><a href=\"#Configuration\" class=\"headerlink\" title=\"Configuration\"></a>Configuration</h3><p><code>见底部  Configuration</code> </p>\n<h3 id=\"Test\"><a href=\"#Test\" class=\"headerlink\" title=\"Test\"></a>Test</h3><h4 id=\"Creating-the-first-migration\"><a href=\"#Creating-the-first-migration\" class=\"headerlink\" title=\"Creating the first migration\"></a>Creating the first migration</h4><p>Now create a first migration in the <code>/sql</code> directory called <code>V1__Create_person_table.sql</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim V1__Create_person_table.sql</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create table PERSON (</span><br><span class=\"line\">    ID int not null,</span><br><span class=\"line\">    NAME varchar(100) not null</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<h4 id=\"Connect-docker\"><a href=\"#Connect-docker\" class=\"headerlink\" title=\"Connect docker\"></a>Connect docker</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up -d flyway</span><br><span class=\"line\">docker-compose <span class=\"built_in\">exec</span> flyway bash</span><br></pre></td></tr></table></figure>\n<h4 id=\"Migrating-the-database\"><a href=\"#Migrating-the-database\" class=\"headerlink\" title=\"Migrating the database\"></a>Migrating the database</h4><p><a href=\"https://flywaydb.org/documentation/commandline/migrate\" target=\"_blank\" rel=\"noopener\">flyway migrate</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway migrate</span><br></pre></td></tr></table></figure>\n<p>If all went well, you should see the following output:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Creating Schema History table: `default`.`flyway_schema_history`</span><br><span class=\"line\">Current version of schema `default`: &lt;&lt; Empty Schema &gt;&gt;</span><br><span class=\"line\">Migrating schema `default` to version 1 - Create person table</span><br></pre></td></tr></table></figure>\n<p><code>version记录，可以在 db 的 flyway_schema_history 数据表中看到</code></p>\n<div class=\"article-img\"><p><img src=\"https://raw.githubusercontent.com/spaco/personal-graph-bed-lucky/master/blog/WX20181216-104924%402x.png\" alt=\"\"></p></div>\n<h4 id=\"Adding-a-second-migration\"><a href=\"#Adding-a-second-migration\" class=\"headerlink\" title=\"Adding a second migration\"></a>Adding a second migration</h4><p>If you now add a second migration to the <code>/sql</code> directory called <code>V2__Add_people.sql</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim ./flyway/sql/V2__Add_people.sql</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into PERSON (ID, NAME) values (1, <span class=\"string\">'Axel'</span>);</span><br><span class=\"line\">insert into PERSON (ID, NAME) values (2, <span class=\"string\">'Mr. Foo'</span>);</span><br><span class=\"line\">insert into PERSON (ID, NAME) values (3, <span class=\"string\">'Ms. Bar'</span>);</span><br></pre></td></tr></table></figure>\n<p>and execute it by issuing:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway migrate</span><br></pre></td></tr></table></figure>\n<p>you now get:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Database: jdbc:mysql://106.14.6.94:3306/default (MySQL 5.7)</span><br><span class=\"line\">Successfully validated 2 migrations (execution time 00:00.137s)</span><br><span class=\"line\">Current version of schema `default`: 1</span><br><span class=\"line\">Migrating schema `default` to version 2 - Add people</span><br><span class=\"line\">Successfully applied 1 migration to schema `default` (execution time 00:00.523s)</span><br></pre></td></tr></table></figure>\n<p><code>migrate version 同样可以在 db 的 flyway_schema_history 数据表看到</code></p>\n<h3 id=\"Other-command\"><a href=\"#Other-command\" class=\"headerlink\" title=\"Other command\"></a>Other command</h3><h4 id=\"flyway-clean-：慎用\"><a href=\"#flyway-clean-：慎用\" class=\"headerlink\" title=\"flyway clean  ：慎用\"></a>flyway clean  ：慎用</h4><p><a href=\"https://flywaydb.org/documentation/commandline/clean\" target=\"_blank\" rel=\"noopener\">flyway clean</a></p>\n<p><code>Drops all objects (tables, views, procedures, triggers, …) in the configured schemas.\nThe schemas are cleaned in the order specified by the</code>schemas<code>property.</code></p>\n<p><code>删除所有的 表 视图 过程 触发器</code>     所有～～</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway clean</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Database: jdbc:mysql://106.14.6.94:3306/default (MySQL 5.7)</span><br><span class=\"line\">Successfully cleaned schema `default` (execution time 00:00.224s)</span><br><span class=\"line\"><span class=\"comment\"># 此时所有的表都没了</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"flyway-info\"><a href=\"#flyway-info\" class=\"headerlink\" title=\"flyway info\"></a>flyway info</h4><p><a href=\"https://flywaydb.org/documentation/commandline/info\" target=\"_blank\" rel=\"noopener\">flyway clean</a></p>\n<p><code>Prints the details and status information about all the migrations.</code></p>\n<p><code>打印有关所有迁移的详细信息和状态信息。</code></p>\n<h4 id=\"flyway-validate-可作为-migration-前置命令\"><a href=\"#flyway-validate-可作为-migration-前置命令\" class=\"headerlink\" title=\"flyway validate : 可作为 migration 前置命令\"></a>flyway validate : 可作为 migration 前置命令</h4><p><a href=\"https://flywaydb.org/documentation/commandline/validate\" target=\"_blank\" rel=\"noopener\">flyway validate</a></p>\n<p>假设 开发A 创建了 <code>V2__Add_user.sql</code> , 开发 B 创建了 `V2__Add_user2.sql’,造成版本差错</p>\n<p>此时：<code>ERROR: Found more than one migration with version 2</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway validate</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Database: jdbc:mysql://106.14.6.94:3306/default (MySQL 5.7)</span><br><span class=\"line\">ERROR: Found more than one migration with version 2   <span class=\"comment\"># 版本2 migration more than one</span></span><br><span class=\"line\">Offenders:</span><br><span class=\"line\">-&gt; /flyway/sql/V2__Add_people.sql (SQL)</span><br><span class=\"line\">-&gt; /flyway/sql/V2__Add_people2.sql (SQL)</span><br></pre></td></tr></table></figure>\n<h4 id=\"undo-：-not-supported-by-Flyway-Community-Edition\"><a href=\"#undo-：-not-supported-by-Flyway-Community-Edition\" class=\"headerlink\" title=\"undo ： not supported by Flyway Community Edition\"></a>undo ： not supported by Flyway Community Edition</h4><p><code>undo the most recently applied versioned migration.</code></p>\n<p><a href=\"https://flywaydb.org/documentation/commandline/undo\" target=\"_blank\" rel=\"noopener\">undo</a></p>\n<p><a href=\"https://flywaydb.org/documentation/commandline/undo\" target=\"_blank\" rel=\"noopener\">undo Important notes</a>  ！！！</p>\n<ul>\n<li><p>This should be complemented with a <strong>proper, well tested, backup and restore strategy</strong> ： </p>\n</li>\n<li><p>undo fail : you end up creating home-made alternatives for restoring backups, which need to be properly tested as well.</p>\n</li>\n<li><strong>maintain backwards compatibility between the DB and all versions of the code currently deployed in production</strong> :This way a failed migration is not a disaster. The old version of the application is still compatible with the DB, so you can simply roll back the application code （即 迁移失败不可怕，回滚code保证老代码适应DB）</li>\n</ul>\n<p><code>撤消最近应用的版本化迁移 -target=** 确定版本名</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway undo</span><br></pre></td></tr></table></figure>\n<p><code>undo is not supported by Flyway Community Edition</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR: Flyway Pro Edition or Flyway Enterprise Edition upgrade required: undo is not supported by Flyway Community Edition.</span><br></pre></td></tr></table></figure>\n<h4 id=\"baseline\"><a href=\"#baseline\" class=\"headerlink\" title=\"baseline\"></a>baseline</h4><p><a href=\"https://flywaydb.org/documentation/commandline/baseline\" target=\"_blank\" rel=\"noopener\">baseline</a></p>\n<p><code>Baselines an existing database, excluding all migrations up to and including baselineVersion</code></p>\n<p><code>生成 版本历史记录库，按照默认流程，版本记录库是已经生成的,默认表名：flyway_schema_history，此步骤可以跳过</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway baseline</span><br><span class=\"line\"><span class=\"comment\"># error</span></span><br><span class=\"line\">Database: jdbc:mysql://106.14.6.94:3306/default (MySQL 5.7)</span><br><span class=\"line\">ERROR: Unable to baseline schema <span class=\"built_in\">history</span> table `default`.`flyway_schema_history` as it already contains migrations</span><br></pre></td></tr></table></figure>\n<h4 id=\"repair\"><a href=\"#repair\" class=\"headerlink\" title=\"repair\"></a>repair</h4><p><a href=\"https://flywaydb.org/documentation/commandline/repair\" target=\"_blank\" rel=\"noopener\">repair</a></p>\n<p><code>Repairs the Flyway schema history table. This will perform the following actions:</code></p>\n<p><code>即 清理 failed migrations，保证版本 log 的完整性</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway repair</span><br><span class=\"line\"></span><br><span class=\"line\">Successfully repaired schema <span class=\"built_in\">history</span> table `default`.`flyway_schema_history` (execution time 00:00.224s).</span><br></pre></td></tr></table></figure>\n<h3 id=\"Deploy\"><a href=\"#Deploy\" class=\"headerlink\" title=\"Deploy\"></a>Deploy</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flyway validate</span><br><span class=\"line\">flyway migrate</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#test last</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h3><ul>\n<li><a href=\"https://flywaydb.org/\" target=\"_blank\" rel=\"noopener\">flyway.org</a></li>\n</ul>\n<h3 id=\"QAQ\"><a href=\"#QAQ\" class=\"headerlink\" title=\"QAQ\"></a>QAQ</h3><ul>\n<li><p>docker-compose.yml 中，关于command 的设置无效，无法映射到 conf 下，导致 flyway.url 为空</p>\n<p>A :</p>\n<p>使用 volumes ：</p>\n<p>volumes:</p>\n<p>​        - “./flyway/sql/:/flyway/sql”</p>\n<p>​        - “./flyway/conf/:/flyway/conf”</p>\n</li>\n</ul>\n<h3 id=\"Extra\"><a href=\"#Extra\" class=\"headerlink\" title=\"Extra\"></a>Extra</h3><h4 id=\"Configuration-1\"><a href=\"#Configuration-1\" class=\"headerlink\" title=\"Configuration\"></a>Configuration</h4><ul>\n<li><p>docker-compose.yml</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 事实上，关于 url user 的配置放于 ./flyway/conf/flyway.conf 中，command 中的参数不重要，但是删除 也不行，会无法启动 flyway</span></span><br><span class=\"line\"><span class=\"comment\">### Flyway ################################################</span></span><br><span class=\"line\">    flyway:</span><br><span class=\"line\">      image: boxfuse/flyway:<span class=\"number\">5.2</span>.<span class=\"number\">4</span>  <span class=\"comment\">#也可以去掉版本号，使用最新的</span></span><br><span class=\"line\">      command: -url=jdbc:mysql://db -schemas=myschema -<span class=\"keyword\">user</span>=root -password=root -connectRetries=<span class=\"number\">60</span> migrate</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - <span class=\"string\">\"./flyway/sql/:/flyway/sql\"</span></span><br><span class=\"line\">        - <span class=\"string\">\"./flyway/conf/:/flyway/conf\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>/flyway/conf/flyway.conf</p>\n<p><code>本次是 copy 一份 conf模版，然后配置相关信息，做 docker 映射</code></p>\n<p><a href=\"https://flywaydb.org/documentation/configfiles\" target=\"_blank\" rel=\"noopener\">flyway.conf</a></p>\n<p><a href=\"https://flywaydb.org/documentation/configfiles#structure\" target=\"_blank\" rel=\"noopener\">flyway.conf模版</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 本次单纯设置以下三项基础配置， 其余的请自行配置</span></span><br><span class=\"line\">flyway.url=jdbc:mysql://106.14.6.94:3306/db-name</span><br><span class=\"line\">flyway.user=db-user-name</span><br><span class=\"line\">flyway.password=db-password</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"docker-compose-设置flyway-environment-为pro\"><a href=\"#docker-compose-设置flyway-environment-为pro\" class=\"headerlink\" title=\"docker compose 设置flyway environment 为pro\"></a>docker compose 设置flyway environment 为pro</h4><p>不行的～～</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose logs flyway</span><br><span class=\"line\"></span><br><span class=\"line\">ERROR: Missing license key. Ensure flyway.licenseKey is <span class=\"built_in\">set</span> to a valid Flyway license key (<span class=\"string\">\"FL01\"</span> followed by 512 hex chars)</span><br></pre></td></tr></table></figure>\n","next":{"title":"Mysql transaction","slug":"mysql-transaction"},"link":"https://spaco.github.io/post/DBmigration-flyway/","toc":[{"title":"Flyway","id":"Flyway","index":"1","children":[{"title":"Introduction","id":"Introduction","index":"1.1","children":[{"title":"Development environment","id":"Development-environment","index":"1.1.1"}]},{"title":"Install","id":"Install","index":"1.2"},{"title":"Configuration","id":"Configuration","index":"1.3"},{"title":"Test","id":"Test","index":"1.4","children":[{"title":"Creating the first migration","id":"Creating-the-first-migration","index":"1.4.1"},{"title":"Connect docker","id":"Connect-docker","index":"1.4.2"},{"title":"Migrating the database","id":"Migrating-the-database","index":"1.4.3"},{"title":"Adding a second migration","id":"Adding-a-second-migration","index":"1.4.4"}]},{"title":"Other command","id":"Other-command","index":"1.5","children":[{"title":"flyway clean  ：慎用","id":"flyway-clean-：慎用","index":"1.5.1"},{"title":"flyway info","id":"flyway-info","index":"1.5.2"},{"title":"flyway validate : 可作为 migration 前置命令","id":"flyway-validate-可作为-migration-前置命令","index":"1.5.3"},{"title":"undo ： not supported by Flyway Community Edition","id":"undo-：-not-supported-by-Flyway-Community-Edition","index":"1.5.4"},{"title":"baseline","id":"baseline","index":"1.5.5"},{"title":"repair","id":"repair","index":"1.5.6"}]},{"title":"Deploy","id":"Deploy","index":"1.6"},{"title":"References","id":"References","index":"1.7"},{"title":"QAQ","id":"QAQ","index":"1.8"},{"title":"Extra","id":"Extra","index":"1.9","children":[{"title":"Configuration","id":"Configuration-1","index":"1.9.1"},{"title":"docker compose 设置flyway environment 为pro","id":"docker-compose-设置flyway-environment-为pro","index":"1.9.2"}]}]}]}