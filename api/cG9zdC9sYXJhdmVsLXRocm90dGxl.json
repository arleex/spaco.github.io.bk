{"title":"laravel-throttle","date":"2019-10-10T00:00:00.000Z","thumbnail":"https://spaco.oss-cn-hangzhou.aliyuncs.com/banners/ZhUwdBwIDiIefFYJ.jpg?x-oss-process=image/resize,m_fixed,h_1280,w_720","link":"post/laravel-throttle","tags":["laravel"],"categories":["program"],"updated":"2019-10-10T00:00:00.000Z","content":"<h2 id=\"Throttle\">Throttle<a href=\"post/laravel-throttle#Throttle\"></a></h2><p>Throttle : 风门 喉咙 喉</p>\n<p>结论：以每分钟请求数为单位，但是间隔可以为小数<br>60,1 一分钟请求60次<br>6,0.1  6秒请求6次</p>\n<h3 id=\"Kernel-php\">Kernel.php<a href=\"post/laravel-throttle#Kernel-php\"></a></h3><figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># App\\Http\\Kernel.php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">protected</span> $routeMiddleware = [</span><br><span class=\"line\">  <span class=\"string\">'auth'</span> =&gt; \\App\\Http\\Middleware\\Authenticate::class,</span><br><span class=\"line\">  <span class=\"string\">'auth.basic'</span> =&gt; \\Illuminate\\Auth\\Middleware\\AuthenticateWithBasicAuth::class,</span><br><span class=\"line\">  <span class=\"string\">'bindings'</span> =&gt; \\Illuminate\\Routing\\Middleware\\SubstituteBindings::class,</span><br><span class=\"line\">  <span class=\"string\">'cache.headers'</span> =&gt; \\Illuminate\\Http\\Middleware\\SetCacheHeaders::class,</span><br><span class=\"line\">  <span class=\"string\">'can'</span> =&gt; \\Illuminate\\Auth\\Middleware\\Authorize::class,</span><br><span class=\"line\">  <span class=\"string\">'guest'</span> =&gt; \\App\\Http\\Middleware\\RedirectIfAuthenticated::class,</span><br><span class=\"line\">  <span class=\"string\">'signed'</span> =&gt; \\Illuminate\\Routing\\Middleware\\ValidateSignature::class,</span><br><span class=\"line\">  <span class=\"string\">'throttle'</span> =&gt; \\Illuminate\\Routing\\Middleware\\ThrottleRequests::class,</span><br><span class=\"line\">  <span class=\"string\">'verified'</span> =&gt; \\Illuminate\\Auth\\Middleware\\EnsureEmailIsVerified::class,</span><br><span class=\"line\">];</span><br></pre></td></tr></table></div></figure>\n<p>可以看到 <code>throttle</code>  对应 <code>\\Illuminate\\Routing\\Middleware\\ThrottleRequests::class</code></p>\n<h3 id=\"ThrottleRequests-php\">ThrottleRequests.php<a href=\"post/laravel-throttle#ThrottleRequests-php\"></a></h3><figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Illuminate\\Routing\\Middleware\\ThrottleRequests</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">($request, Closure $next, $maxAttempts = <span class=\"number\">60</span>, $decayMinutes = <span class=\"number\">1</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"comment\"># 根据当前 默认guard登陆用户 或 当前domain+ip 生成签名</span></span><br><span class=\"line\">  $key = <span class=\"keyword\">$this</span>-&gt;resolveRequestSignature($request);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\"># 根据 中间件的参数获取最大接口请求数量</span></span><br><span class=\"line\">  <span class=\"comment\"># \"60,1\" =&gt; 1分钟内最多请求60次</span></span><br><span class=\"line\">  <span class=\"comment\"># \"30|60,1\" =&gt; 1分钟内，已登录用户请求上线60次，未登录用户请求上线30次</span></span><br><span class=\"line\">  <span class=\"comment\"># \"guard user property|1\" =&gt; 若设置的是已登录用户的可访问属性，则返回对应属性guard user property的值</span></span><br><span class=\"line\">  $maxAttempts = <span class=\"keyword\">$this</span>-&gt;resolveMaxAttempts($request, $maxAttempts);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 从cache中获取签名对应的请求数，若大于最大请求数，抛出异常 &amp; 返回响应Header数据</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">$this</span>-&gt;limiter-&gt;tooManyAttempts($key, $maxAttempts)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">$this</span>-&gt;buildException($key, $maxAttempts);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 根据签名，设置具体请求缓存，缓存时间为 请求时间段 decayMinutes * 60，1分钟请求限制，缓存时间为60秒</span></span><br><span class=\"line\">  <span class=\"comment\"># 设置 签名+'：timer'缓存，值为当前时间戳+60秒</span></span><br><span class=\"line\">\t<span class=\"comment\"># 设置请求缓存数+1</span></span><br><span class=\"line\">  <span class=\"keyword\">$this</span>-&gt;limiter-&gt;hit($key, $decayMinutes * <span class=\"number\">60</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  $response = $next($request);</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\"># 返回响应Header &amp;&amp; 接口响应用户</span></span><br><span class=\"line\">  <span class=\"comment\"># Header内容：['X-RateLimit-Limit','X-RateLimit-Remaining']</span></span><br><span class=\"line\">  <span class=\"comment\"># 依次为 最大请求数，剩余可请求数</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;addHeaders(</span><br><span class=\"line\">    $response, $maxAttempts,</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;calculateRemainingAttempts($key, $maxAttempts)</span><br><span class=\"line\">  );</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n","next":{"title":"spring cloud config source code analysis","link":"post/spring-cloud-config-source-code-analysis"},"plink":"https://spaco.github.io/post/laravel-throttle/","toc":[{"title":"Throttle","id":"Throttle","index":"1","children":[{"title":"Kernel.php","id":"Kernel-php","index":"1.1"},{"title":"ThrottleRequests.php","id":"ThrottleRequests-php","index":"1.2"}]}]}