{"title":"Mysql transaction","date":"2018-12-09T00:00:00.000Z","slug":"mysql-transaction","tags":["mysql"],"categories":["program"],"updated":"2019-01-03T03:16:58.381Z","content":"<p>数据库事务（Database Transaction）,是指作为单个逻辑工作单元执行的一系列操作，要么完全执行，要么完全地不执行</p>\n<h3 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例\"></a>案例</h3><ul>\n<li>A 转账给B 6元,  需要保证，A减少 6 元，B增加 6 元，缺一不可</li>\n</ul>\n<h3 id=\"Development-Environment\"><a href=\"#Development-Environment\" class=\"headerlink\" title=\"Development Environment\"></a>Development Environment</h3><ul>\n<li><p>mysql </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: 5.7</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"相关概念\"><a href=\"#相关概念\" class=\"headerlink\" title=\"相关概念\"></a>相关概念</h3><ul>\n<li><p>ACID特性</p>\n<p><strong>Atomicity</strong> ： <strong>原子性</strong></p>\n<p>一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。也就是说事务是一个不可分割的整体，就像化学中学过的原子，是物质构成的基本单位</p>\n<p><strong>Consistency</strong> ： <strong>一致性</strong></p>\n<p>事务开始前和结束后，数据库的完整性约束没有被破坏 。比如A向B转账，不可能A扣了钱，B却没收到</p>\n<p><strong>Isolation</strong> ： <strong>隔离性</strong></p>\n<p>数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）</p>\n<p>同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰。比如A正在从一张银行卡中取钱，在A取钱的过程结束前，B不能向这张卡转账</p>\n<p><strong>Durability</strong> ： <strong>持久性</strong></p>\n<p>事务完成后，事务对数据库的所有更新将被保存到数据库，不可回滚</p>\n</li>\n<li><p>事务隔离级别</p>\n<p><strong>read-uncommitted</strong>  ： <strong>读未提交</strong></p>\n<p><strong>read-committed</strong>  ： <strong>读已提交</strong> </p>\n<p><strong>repeatable-read</strong>  ：  <strong>可重复读</strong>   (mysql5.7默认级别)</p>\n<p><strong>serializable</strong>  ：  <strong>串行化</strong></p>\n</li>\n</ul>\n<h3 id=\"ACID\"><a href=\"#ACID\" class=\"headerlink\" title=\"ACID\"></a>ACID</h3><h3 id=\"Create-test-data\"><a href=\"#Create-test-data\" class=\"headerlink\" title=\"Create test data\"></a>Create test data</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建数据库</span></span><br><span class=\"line\">create database transaction default character <span class=\"built_in\">set</span> utf8mb4 collate utf8mb4_unicode_ci;</span><br><span class=\"line\"><span class=\"comment\"># 创建数据表</span></span><br><span class=\"line\">CREATE TABLE `transaction`.`account`  (</span><br><span class=\"line\">  `id` bigint(11) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `name` varchar(55) NULL COMMENT <span class=\"string\">'姓名'</span>,</span><br><span class=\"line\">  `balance` decimal(10, 2) NULL COMMENT <span class=\"string\">'余额'</span>,</span><br><span class=\"line\">  PRIMARY KEY (`id`)</span><br><span class=\"line\">) COMMENT = <span class=\"string\">'账号表'</span>;</span><br><span class=\"line\"><span class=\"comment\"># 插入测试数据</span></span><br><span class=\"line\">INSERT INTO `transaction`.`account`(`name`, `balance`) VALUES (<span class=\"string\">'joe'</span>, 450);</span><br><span class=\"line\">INSERT INTO `transaction`.`account`(`name`, `balance`) VALUES (<span class=\"string\">'she'</span>, 600);</span><br></pre></td></tr></table></figure>\n<h3 id=\"隔离级别-举例说明\"><a href=\"#隔离级别-举例说明\" class=\"headerlink\" title=\"隔离级别 举例说明\"></a>隔离级别 举例说明</h3><ul>\n<li><p>read-uncommitted</p>\n<ol>\n<li><p>打开客户端 A ,并设置当前事务级别为read-uncommitted（未提交读），并查询表account的初始值</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入 mysql 命令行</span></span><br><span class=\"line\">mysql -uroot -proot</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置当前窗口事务级别为 read uncommitted</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> session transaction isolation level <span class=\"built_in\">read</span> uncommitted;</span><br><span class=\"line\"><span class=\"comment\"># Query OK, 0 rows affected (0.00 sec)</span></span><br><span class=\"line\">use transaction;</span><br><span class=\"line\">start transaction;</span><br><span class=\"line\">select * from account;</span><br><span class=\"line\"></span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  450.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开客户端 B ,同样设置当前事务级别为 read uncommitted ，并更新数据</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql -uroot -proot</span><br><span class=\"line\"><span class=\"built_in\">set</span> session transaction isolation level <span class=\"built_in\">read</span> uncommitted;</span><br><span class=\"line\">use transaction;</span><br><span class=\"line\">start transaction;</span><br><span class=\"line\">update account <span class=\"built_in\">set</span> balance = balance-50 <span class=\"built_in\">where</span> id = 1;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>返回客户端 A，B 的事务未提交, 窗口 A 仍然可以查看更新后的数据</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>返回客户端 B,假设因为异常数据回滚，那么此时客户端 A 返回给用户的数据就是 <code>脏数据</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 客户端 B</span></span><br><span class=\"line\">select * from account;</span><br><span class=\"line\"></span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Q1:回滚之前，id=1 id=2两条数据是否可写？</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 回滚</span></span><br><span class=\"line\">rollback;</span><br><span class=\"line\"></span><br><span class=\"line\">select * from account;</span><br><span class=\"line\"></span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  450.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开客户端 A ,执行减少 50 的更新操作，结果并不是400-50=350, 而是 400，<code>用户把钱全转出去，操作结束发现还剩50</code></p>\n<p>在应用程序中，我们会用400-50=350，并不知道其他会话回滚了，要想解决这个问题可以采用 <code>read-committed</code> 的隔离级别</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 客户端 A</span></span><br><span class=\"line\">mysql&gt; select * from account;  <span class=\"comment\"># 此步骤是在客户端 B 未rollback 时执行</span></span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下命令是在rollback 已执行的情况下运行</span></span><br><span class=\"line\">mysql&gt; update account <span class=\"built_in\">set</span> balance = balance-50 <span class=\"built_in\">where</span> id = 1;</span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br><span class=\"line\">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>read committed</p>\n<ol>\n<li><p>打开一个客户端 A，并设置当前事务模式为read committed，查询表account的所有记录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  450.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开客户端 B, 开启一个事务，并更新数据</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 客户端 B</span></span><br><span class=\"line\">mysql&gt; start transaction;</span><br><span class=\"line\">Query OK, 0 rows affected (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; update account <span class=\"built_in\">set</span> balance = balance-50 <span class=\"built_in\">where</span> id = 1;</span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br><span class=\"line\">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开客户端 A, 查看所有记录，未读取到 B 已经更新的数据 ,  <code>解决了脏读</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\"></span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  450.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开客户端 B, 提交事务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\"></span><br><span class=\"line\">commit;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开客户端 A, 执行查看所有的查询，发现与上一步结果不一致,产生 <code>不可重复读</code> 问题</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  450.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>repeatable read</p>\n<ol>\n<li><p>打开客户端 A, 查询表account的所有记录</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">set</span> session transaction isolation level repeatable <span class=\"built_in\">read</span>;</span><br><span class=\"line\">start transaction;</span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在客户端A的事务提交之前，打开另一个客户端B，更新表account</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; update account <span class=\"built_in\">set</span> balance = balance-50 <span class=\"built_in\">where</span> id = 1;</span><br><span class=\"line\">Query OK, 1 row affected (0.01 sec)</span><br><span class=\"line\">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  350.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在客户端A查询表account的所有记录，与上一步查询结果一致，没有出现不可重复读的问题</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在客户端A，接着执行balance = balance - 50 where id = 1，balance没有变成400-50=350，lilei的balance值用的是步骤（2）中的350来算的，所以是300，数据的一致性倒是没有被破坏。可重复读的隔离级别下使用了MVCC机制，select操作不会更新版本号，是快照读（历史版本）；insert、update和delete会更新版本号，是当前读（当前版本）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">2 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; update balance = balance - 50 <span class=\"built_in\">where</span> id = 1^C</span><br><span class=\"line\">mysql&gt; update account <span class=\"built_in\">set</span> balance = balance-50 <span class=\"built_in\">where</span> id = 1;</span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br><span class=\"line\">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  300.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\"></span><br><span class=\"line\">commit;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重新打开客户端B，插入一条新数据</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; insert into account values(4,<span class=\"string\">'kid'</span>,700);</span><br><span class=\"line\">Query OK, 1 row affected (0.01 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  350.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">|  4 | kid  |  700.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在客户端A查询表account的所有记录，没有 查出 新增数据，所以没有出现幻读</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  350.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><p>serializable</p>\n<ol>\n<li><p>打开一个客户端A，并设置当前事务模式为serializable，查询表account的初始值：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"built_in\">set</span> session transaction isolation level serializable;</span><br><span class=\"line\">Query OK, 0 rows affected (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; start transaction;</span><br><span class=\"line\">Query OK, 0 rows affected (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from account;</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">| id | name | balance |</span><br><span class=\"line\">+----+------+---------+</span><br><span class=\"line\">|  1 | joe  |  400.00 |</span><br><span class=\"line\">|  2 | she  |  600.00 |</span><br><span class=\"line\">|  4 | kid  |  700.00 |</span><br><span class=\"line\">+----+------+---------+</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打开一个客户端 B，并设置当前事务模式为serializable，插入一条记录报错，表被锁了插入失败，mysql中事务隔离级别为serializable时会锁表，因此不会出现幻读的情况，这种隔离级别并发性极低，开发中很少会用到</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">set</span> session transaction isolation level serializable;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; insert into account values(5,<span class=\"string\">'tom'</span>,0);</span><br><span class=\"line\">ERROR 1205 (HY000): Lock <span class=\"built_in\">wait</span> timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n</ul>\n<ol>\n<li>s </li>\n<li></li>\n</ol>\n<h3 id=\"查看隔离级别\"><a href=\"#查看隔离级别\" class=\"headerlink\" title=\"查看隔离级别\"></a>查看隔离级别</h3><p>mysql默认的事务处理级别是’REPEATABLE-READ’,也就是可重复读</p>\n<ol>\n<li>查看当前会话隔离级别</li>\n</ol>\n<p>select @@tx_isolation;</p>\n<ol start=\"2\">\n<li>查看系统当前隔离级别</li>\n</ol>\n<p>select @@global.tx_isolation;</p>\n<ol start=\"3\">\n<li>设置当前会话隔离级别</li>\n</ol>\n<p>set session transaction isolatin level repeatable read;</p>\n<ol start=\"4\">\n<li>设置系统当前隔离级别</li>\n</ol>\n<p>set global transaction isolation level repeatable read;</p>\n","prev":{"title":"DB migration Flyway","slug":"DBmigration-flyway"},"next":{"title":"recommended software installed on mac or windows","slug":"recommended-software-installed-on-mac-windows"},"link":"https://spaco.github.io/post/mysql-transaction/"}