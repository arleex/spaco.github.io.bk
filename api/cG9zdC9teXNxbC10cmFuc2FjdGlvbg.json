{"title":"Mysql transaction","date":"2018-12-09T00:00:00.000Z","slug":"mysql-transaction","tags":["mysql"],"categories":["program"],"updated":"2018-12-17T01:15:50.199Z","content":"<p>数据库事务（Database Transaction）,是指作为单个逻辑工作单元执行的一系列操作，要么完全执行，要么完全地不执行</p>\n<h3 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例\"></a>案例</h3><ul>\n<li>A 转账给B 6元,  需要保证，A减少 6 元，B增加 6 元，缺一不可</li>\n</ul>\n<h3 id=\"相关概念\"><a href=\"#相关概念\" class=\"headerlink\" title=\"相关概念\"></a>相关概念</h3><ul>\n<li><p>ACID特性</p>\n<p><strong>Atomicity</strong> ： <strong>原子性</strong></p>\n<p>一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。也就是说事务是一个不可分割的整体，就像化学中学过的原子，是物质构成的基本单位</p>\n<p><strong>Consistency</strong> ： <strong>一致性</strong></p>\n<p>事务开始前和结束后，数据库的完整性约束没有被破坏 。比如A向B转账，不可能A扣了钱，B却没收到</p>\n<p><strong>Isolation</strong> ： <strong>隔离性</strong></p>\n<p>数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）</p>\n<p>同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰。比如A正在从一张银行卡中取钱，在A取钱的过程结束前，B不能向这张卡转账</p>\n<p><strong>Durability</strong> ： <strong>持久性</strong></p>\n<p>事务完成后，事务对数据库的所有更新将被保存到数据库，不可回滚</p>\n</li>\n<li><p>事务隔离级别</p>\n<p><strong>read-uncommitted</strong>  ： <strong>读未提交</strong></p>\n<p><strong>read-committed</strong>  ： <strong>读已提</strong></p>\n<p><strong>repeatable-read</strong>  ：  <strong>可重复读</strong></p>\n<p><strong>serializable</strong>  ：  <strong>串行化</strong></p>\n</li>\n</ul>\n<h3 id=\"ACID\"><a href=\"#ACID\" class=\"headerlink\" title=\"ACID\"></a>ACID</h3><h3 id=\"隔离级别\"><a href=\"#隔离级别\" class=\"headerlink\" title=\"隔离级别\"></a>隔离级别</h3><p>建立测试数据</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create database transaction default character <span class=\"built_in\">set</span> utf8mb4 collate utf8mb4_unicode_ci;</span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `transaction`.`account`  (</span><br><span class=\"line\">  `id` bigint(11) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `name` varchar(55) NULL COMMENT <span class=\"string\">'姓名'</span>,</span><br><span class=\"line\">  `balance` decimal(10, 2) NULL COMMENT <span class=\"string\">'余额'</span>,</span><br><span class=\"line\">  PRIMARY KEY (`id`)</span><br><span class=\"line\">) COMMENT = <span class=\"string\">'账号表'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO `transaction`.`account`(`name`, `balance`) VALUES (<span class=\"string\">'joe'</span>, 100)</span><br><span class=\"line\">INSERT INTO `transaction`.`account`(`name`, `balance`) VALUES (<span class=\"string\">'she'</span>, 200)</span><br></pre></td></tr></table></figure>\n<ol>\n<li><p>read-uncommitted</p>\n<ul>\n<li><p>打开客户端 A ,并设置当前事务模式为read uncommitted（未提交读），查询表account的初始值：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入 mysql 命令行</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> session transaction isolation level <span class=\"built_in\">read</span> uncommitted;</span><br><span class=\"line\"><span class=\"comment\"># Query OK, 0 rows affected (0.00 sec)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开启事务</span></span><br><span class=\"line\">start transaction;</span><br><span class=\"line\"><span class=\"comment\"># Query OK, 0 rows affected (0.00 sec)</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"查看隔离级别\"><a href=\"#查看隔离级别\" class=\"headerlink\" title=\"查看隔离级别\"></a>查看隔离级别</h3><p>mysql默认的事务处理级别是’REPEATABLE-READ’,也就是可重复读</p>\n<ol>\n<li>查看当前会话隔离级别</li>\n</ol>\n<p>select @@tx_isolation;</p>\n<ol start=\"2\">\n<li>查看系统当前隔离级别</li>\n</ol>\n<p>select @@global.tx_isolation;</p>\n<ol start=\"3\">\n<li>设置当前会话隔离级别</li>\n</ol>\n<p>set session transaction isolatin level repeatable read;</p>\n<ol start=\"4\">\n<li>设置系统当前隔离级别</li>\n</ol>\n<p>set global transaction isolation level repeatable read;</p>\n","prev":{"title":"","slug":"DBmigration-flyway"},"next":{"title":"recommended software installed on mac or windows","slug":"recommended-software-installed-on-mac-windows"},"link":"https://spaco.github.io/post/mysql-transaction/"}