{"title":"laravel-envoy","date":"2019-07-02T00:00:00.000Z","link":"post/laravel-envoy","tags":["laravel-envoy"],"categories":["program"],"updated":"2019-07-02T00:00:00.000Z","content":"<h2 id=\"Introduction\">Introduction<a href=\"post/laravel-envoy#Introduction\"></a></h2><h3 id=\"What-is-laravel-envoy\">What is laravel-envoy<a href=\"post/laravel-envoy#What-is-laravel-envoy\"></a></h3><p>Suppose you hava a samll project of your own,put it on a remote server. Every time you develop a function for this<br>small project, you have to go online. The general operation will be the following.</p>\n<ol>\n<li>connect to server <code>ssh username@ip</code></li>\n<li>enter the project  <code>cd workspace/my project</code></li>\n<li>update local code to the latest  <code>git pull</code></li>\n</ol>\n<p>Doing this thing manually for too long,It feels bad ～</p>\n<p><a href=\"https://github.com/laravel/envoy\" target=\"_blank\" rel=\"noopener\">Laravel Envoy</a> provides a clean, minimal syntax for defining common tasks you run on<br> your remote servers. Using Blade style syntax, you can easily setup tasks for deployment, Artisan commands, and more.<br> Currently, Envoy only supports the Mac and Linux operating systems.</p>\n<p>Allows you to do all of the above with a minimum of configuration,just by executing the following line of commands from the local command line.</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy run deploy</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Install\">Install<a href=\"post/laravel-envoy#Install\"></a></h3><p>First, install Envoy using the Composer <code>global require</code> command:</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer global require laravel/envoy</span><br></pre></td></tr></table></div></figure>\n<p>Since global Composer libraries can sometimes cause package version conflicts, you may wish to consider using <code>cgr</code>, which is a drop-in replacement for the <code>composer global require</code>command. The <code>cgr</code> library’s installation instructions can be <a href=\"https://github.com/consolidation-org/cgr\" target=\"_blank\" rel=\"noopener\">found on GitHub</a>.</p>\n<p>After installed,you can see it in the <code>~/.composer/vendor/bin</code> directory</p>\n<p><code>Make sure to place the</code>~/.composer/vendor/bin<code>directory in your PATH so the</code>envoy<code>executable is found when running the</code>envoy<code>command in your terminal.</code></p>\n<p>executing the following line of commands from the local command line.</p>\n <figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"string\">\"<span class=\"variable\">$PATH</span>:<span class=\"variable\">$HOME</span>/.composer/vendor/bin\"</span></span><br></pre></td></tr></table></div></figure>\n<p>or </p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># i am using zsh, update .bash_profile is also useful</span></span><br><span class=\"line\"></span><br><span class=\"line\">vim ~/.bash_profile</span><br><span class=\"line\"><span class=\"comment\"># add this line</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"string\">\"<span class=\"variable\">$PATH</span>:<span class=\"variable\">$HOME</span>/.composer/vendor/bin\"</span></span><br><span class=\"line\"><span class=\"comment\"># refresh .bash_profile</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bash_profile</span><br></pre></td></tr></table></div></figure>\n<p>In order to test whether the installation was successful</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy --version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># show like this</span></span><br><span class=\"line\">Laravel Envoy 1.5.0</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"Updating-Envoy\">Updating Envoy<a href=\"post/laravel-envoy#Updating-Envoy\"></a></h4><figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer global update</span><br></pre></td></tr></table></div></figure>\n<p>To view a list of all available Envoy commands, you may use the <code>list</code> command:</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy list</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"Writing-Tasks\">Writing Tasks<a href=\"post/laravel-envoy#Writing-Tasks\"></a></h2><p>First, in your project root directory , execute the following command to initialize</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy init root@127.0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># show like this</span></span><br><span class=\"line\">Envoy file created!</span><br></pre></td></tr></table></div></figure>\n<p><code>Envoy.blade.php</code> is created</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@servers([<span class=\"string\">'web'</span> =&gt; <span class=\"string\">'root@127.0.0.1'</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'deploy'</span>)</span><br><span class=\"line\">    <span class=\"built_in\">cd</span> /path/to/site</span><br><span class=\"line\">    git pull origin master</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Variables\">Variables<a href=\"post/laravel-envoy#Variables\"></a></h3><p>If needed, you may pass option values into Envoy tasks using the command line:</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy run deploy --branch=master</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@servers([<span class=\"string\">'web'</span> =&gt; <span class=\"string\">'192.168.1.1'</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'deploy'</span>, [<span class=\"string\">'on'</span> =&gt; <span class=\"string\">'web'</span>])</span><br><span class=\"line\">    cd site</span><br><span class=\"line\"></span><br><span class=\"line\">    @<span class=\"keyword\">if</span> ($branch)</span><br><span class=\"line\">        git pull origin &#123;&#123; $branch &#125;&#125;</span><br><span class=\"line\">    @<span class=\"keyword\">endif</span></span><br><span class=\"line\"></span><br><span class=\"line\">    php artisan migrate</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Stories\">Stories<a href=\"post/laravel-envoy#Stories\"></a></h3><p>Stories group a set of tasks under a single, convenient name, allowing you to group small, focused tasks into large tasks. For instance, a <code>deploy</code> story may run the <code>git</code> and <code>composer</code>tasks by listing the task names within its definition:</p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@servers([<span class=\"string\">'web'</span> =&gt; <span class=\"string\">'192.168.1.1'</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">@story(<span class=\"string\">'deploy'</span>)</span><br><span class=\"line\">    git</span><br><span class=\"line\">    composer</span><br><span class=\"line\">@endstory</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'git'</span>)</span><br><span class=\"line\">    git pull origin master</span><br><span class=\"line\">@endtask</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'composer'</span>)</span><br><span class=\"line\">    composer install</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<p>Once the story has been written, you may run it just like a typical task:</p>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy run deploy</span><br></pre></td></tr></table></div></figure>\n<p>Attention: </p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@servers([<span class=\"string\">'web'</span> =&gt; <span class=\"string\">'192.168.1.1'</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">@story(<span class=\"string\">'deploy'</span>)</span><br><span class=\"line\">    task1</span><br><span class=\"line\">    task2</span><br><span class=\"line\">@endstory</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'task1'</span>)</span><br><span class=\"line\">  \tcd ~/code</span><br><span class=\"line\">    pwd</span><br><span class=\"line\">@endtask</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'task2'</span>)</span><br><span class=\"line\">    composer install</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<p>在story里，只能使用tasks, 并且第一个 task <code>cd</code> 进入 code 目录，不代表第二个 task 在 code 目录中 </p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@story(<span class=\"string\">'deploy'</span>)</span><br><span class=\"line\">  \tcd /workspace/project   <span class=\"comment\">// error!</span></span><br><span class=\"line\">    task1</span><br><span class=\"line\">    task2</span><br><span class=\"line\">@endstory</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># about pwd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># task1</span></span><br><span class=\"line\">/root/code</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># task2</span></span><br><span class=\"line\">/root</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Multiple-Servers\">Multiple Servers<a href=\"post/laravel-envoy#Multiple-Servers\"></a></h3><p>Envoy allows you to easily run a task across multiple servers. First, add additional servers to your <code>@servers</code> declaration. Each server should be assigned a unique name. Once you have defined your additional servers, list each of the servers in the task’s <code>on</code> array:</p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@servers([<span class=\"string\">'web-1'</span> =&gt; <span class=\"string\">'192.168.1.1'</span>, <span class=\"string\">'web-2'</span> =&gt; <span class=\"string\">'192.168.1.2'</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'deploy'</span>, [<span class=\"string\">'on'</span> =&gt; [<span class=\"string\">'web-1'</span>, <span class=\"string\">'web-2'</span>]])</span><br><span class=\"line\">    cd site</span><br><span class=\"line\">    git pull origin &#123;&#123; $branch &#125;&#125;</span><br><span class=\"line\">    php artisan migrate</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Parallel-Execution\">Parallel Execution<a href=\"post/laravel-envoy#Parallel-Execution\"></a></h3><p>默认情况下，将在每个服务器上串行执行任务。换句话说，任务将在继续在第二台服务器上执行之前在第一台服务器上完成运行。如果要并行运行多个服务器上的任务，请将该<code>parallel</code>选项添加到任务声明中：</p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@servers([<span class=\"string\">'web-1'</span> =&gt; <span class=\"string\">'192.168.1.1'</span>, <span class=\"string\">'web-2'</span> =&gt; <span class=\"string\">'192.168.1.2'</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">@task(<span class=\"string\">'deploy'</span>, [<span class=\"string\">'on'</span> =&gt; [<span class=\"string\">'web-1'</span>, <span class=\"string\">'web-2'</span>], <span class=\"string\">'parallel'</span> =&gt; <span class=\"keyword\">true</span>])</span><br><span class=\"line\">    cd site</span><br><span class=\"line\">    git pull origin &#123;&#123; $branch &#125;&#125;</span><br><span class=\"line\">    php artisan migrate</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"Running-Tasks\">Running Tasks<a href=\"post/laravel-envoy#Running-Tasks\"></a></h2><figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">envoy run deploy</span><br></pre></td></tr></table></div></figure>\n<h3 id=\"Confirming-Task-Execution\">Confirming Task Execution<a href=\"post/laravel-envoy#Confirming-Task-Execution\"></a></h3><p>如果要在服务器上运行给定任务之前提示您进行确认，则应将该<code>confirm</code>指令添加到任务声明中。此选项对于破坏性操作特别有用：</p>\n<figure class=\"highlight php\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@task(<span class=\"string\">'deploy'</span>, [<span class=\"string\">'on'</span> =&gt; <span class=\"string\">'web'</span>, <span class=\"string\">'confirm'</span> =&gt; <span class=\"keyword\">true</span>])</span><br><span class=\"line\">    cd site</span><br><span class=\"line\">    git pull origin &#123;&#123; $branch &#125;&#125;</span><br><span class=\"line\">    php artisan migrate</span><br><span class=\"line\">@endtask</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"Notifications\">Notifications<a href=\"post/laravel-envoy#Notifications\"></a></h2><p>to be continued</p>\n","prev":{"title":"phpunit","link":"post/phpunit"},"next":{"title":"laravel-login","link":"post/laravel-login"},"plink":"https://spaco.github.io/post/laravel-envoy/","toc":[{"title":"Introduction","id":"Introduction","index":"1","children":[{"title":"What is laravel-envoy","id":"What-is-laravel-envoy","index":"1.1"},{"title":"Install","id":"Install","index":"1.2","children":[{"title":"Updating Envoy","id":"Updating-Envoy","index":"1.2.1"}]}]},{"title":"Writing Tasks","id":"Writing-Tasks","index":"2","children":[{"title":"Variables","id":"Variables","index":"2.1"},{"title":"Stories","id":"Stories","index":"2.2"},{"title":"Multiple Servers","id":"Multiple-Servers","index":"2.3"},{"title":"Parallel Execution","id":"Parallel-Execution","index":"2.4"}]},{"title":"Running Tasks","id":"Running-Tasks","index":"3","children":[{"title":"Confirming Task Execution","id":"Confirming-Task-Execution","index":"3.1"}]},{"title":"Notifications","id":"Notifications","index":"4"}]}